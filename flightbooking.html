<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iberia VA - Book Flight</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://ik.imagekit.io/hswtnwf8i/iberia%20colors.png?updatedAt=1753001611287" type="image/png">
    <style>
        :root {
            --color-primary-red: #DC2626;
            --color-primary-red-hover: #B91C1C;
            --color-discord-blue: #5865F2;
            --color-discord-blue-hover: #4752C4;
            --color-bg-dark: #0F172A;
            --color-bg-light: #1A202C; /* Slightly lighter dark for cards */
            --color-text-light: #E2E8F0;
            --color-text-dark: #F8FAFC;
            --color-input-border: #475569; /* Slate-600 */
            --color-input-focus: #DC2626; /* Red-600 */
            --border-radius-lg: 0.75rem;
            --shadow-subtle: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-strong: 0 8px 20px rgba(0, 0, 0, 0.5);
            --section-padding-y: 6rem; /* Large padding for sections */
            --content-spacing-mb: 4rem; /* Spacing between main content blocks */
        }

        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
            background-color: var(--color-bg-dark);
            color: var(--color-text-light);
            background-image: url('https://ik.imagekit.io/hswtnwf8i/a320%20beria.png?updatedAt=1752938799277');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
            color: var(--color-text-dark);
        }

        /* Hero overlay for better text readability on background image */
        .hero-overlay {
            background-image: linear-gradient(to bottom, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.7) 100%);
        }

        /* Section Specific Styles */
        .container-sleek {
            max-width: 1200px; /* Wider container */
        }
        .py-section-sleek {
            padding-top: var(--section-padding-y);
            padding-bottom: var(--section-padding-y);
        }
        .mb-content-sleek {
            margin-bottom: var(--content-spacing-mb);
        }

        /* Card Background */
        .card-background-sleek {
            background-color: var(--color-bg-light);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-strong); /* Stronger shadow for depth */
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.08); /* Subtle border */
            backdrop-filter: blur(5px); /* Glassmorphism effect */
            background-image: linear-gradient(135deg, rgba(26,32,44,0.7) 0%, rgba(15,23,42,0.8) 100%); /* Subtle gradient */
        }

        /* Section Headings */
        .section-heading-sleek {
            font-size: 2.8rem; /* Larger heading */
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 2rem;
        }

        /* Form Container */
        .form-container-sleek {
            background-color: rgba(26,32,44, 0.9); /* Slightly more opaque for readability */
            padding: 2.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Input Fields */
        .input-field-sleek {
            @apply p-3 rounded-md bg-slate-800 text-slate-100 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent transition duration-300;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        .input-field-sleek:hover {
            border-color: var(--color-input-focus);
        }
        .input-field-sleek::placeholder {
            color: #94A3B8; /* Slate-400 */
        }

        /* Submit Button */
        .btn-submit-sleek {
            @apply bg-red-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-red-700 transition duration-300 transform hover:scale-105;
            letter-spacing: 0.05em;
        }

        /* Scroll-to-top Button */
        #scrollToTopBtn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            background-color: var(--color-primary-red);
            color: white;
            padding: 12px 18px;
            border-radius: 9999px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease, transform 0.3s ease;
            cursor: pointer;
            border: none;
        }
        #scrollToTopBtn:hover {
            background-color: var(--color-primary-red-hover);
            transform: translateY(-3px);
        }

        /* Discord Login Button and User Info Styling (retained with minor tweaks) */
        .discord-login-btn {
            @apply flex items-center justify-center space-x-2 px-6 py-3 rounded-full text-base font-semibold;
            background-color: var(--color-discord-blue);
            color: white;
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .discord-login-btn:hover {
            background-color: var(--color-discord-blue-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        .discord-login-btn svg {
            @apply w-6 h-6;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--color-text-light);
            font-weight: 600;
        }
        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--color-primary-red);
        }
        .logout-button {
            background-color: var(--color-primary-red);
            color: white;
            padding: 0.5rem 1.2rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .logout-button:hover {
            background-color: var(--color-primary-red-hover);
        }

        /* Custom Discord Button (from Uiverse.io - slightly adjusted) */
        .Btn {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background-color: transparent;
            position: relative;
            border-radius: 7px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .svgContainer {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent;
            backdrop-filter: blur(0px);
            letter-spacing: 0.8px;
            border-radius: 10px;
            transition: all 0.3s;
            border: 1px solid rgba(156, 156, 156, 0.466);
        }
        .BG {
            position: absolute;
            content: "";
            width: 100%;
            height: 100%;
            background: var(--color-discord-blue);
            z-index: -1;
            border-radius: 10px;
            pointer-events: none;
            transition: all 0.3s;
        }
        .Btn:hover .BG {
            transform: rotate(35deg);
            transform-origin: bottom;
        }
        .Btn:hover .svgContainer {
            border: 1px solid rgba(206, 206, 206, 0.466);
            background-color: rgba(214, 214, 214, 0.466);
            backdrop-filter: blur(4px);
        }

        /* Loading Screen Styles (improved slightly) */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-bg-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            gap: 20px;
        }
        .video-container {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border: 5px solid var(--color-primary-red);
        }
        .video-container video { /* Changed from iframe to video */
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensures the video covers the container */
        }
        #loading-screen p {
            color: var(--color-text-dark);
        }

        /* Message Box Overlay */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .message-box-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .message-box-content {
            background-color: var(--color-bg-light);
            padding: 2.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-strong);
            text-align: center;
            max-width: 450px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .message-box-overlay.show .message-box-content {
            transform: translateY(0);
        }
        #messageBoxTitle {
            color: var(--color-primary-red);
            margin-bottom: 1rem;
        }
        #messageBoxText {
            color: var(--color-text-light);
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }
        #messageBoxCloseButton {
            @apply bg-red-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-red-700 transition duration-300;
        }

        /* Login Required Message */
        #loginRequiredMessage {
            @apply text-center text-xl text-red-400 p-8 rounded-lg bg-slate-800 shadow-xl border border-red-700 flex flex-col items-center gap-6;
        }
        #loginRequiredMessage .Btn {
            margin-top: 1rem; /* Space between text and button */
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="loading-screen">
        <div class="video-container">
            <video src="iberia animation.gif" autoplay loop muted playsinline></video>
        </div>
        <p class="text-xl font-semibold">Loading...</p>
    </div>

    <div id="main-content" style="display: none;">
        <header class="bg-gray-900 shadow-lg fixed w-full z-10 bg-opacity-90 backdrop-filter backdrop-blur-sm">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center">
                    <img src="https://ik.imagekit.io/hswtnwf8i/iberia%20colors.png?updatedAt=1753001611287" alt="Iberia VA Logo" class="h-10 w-auto mr-2"/>
                    <a href="https://pfiberiava.github.io/flyibe/" class="text-2xl font-bold text-white tracking-wide rounded-md hover:text-red-500 transition duration-300">
                        Iberia VA
                    </a>
                </div>

                <div class="hidden md:flex space-x-8">
                    <a href="index.html" class="text-lg font-medium text-gray-300 hover:text-red-500 transition duration-300 px-3 py-2 rounded-md">Home</a>
                    <a href="#booking" class="text-lg font-medium text-gray-300 hover:text-red-500 transition duration-300 px-3 py-2 rounded-md">Book a Flight</a>
                    <a href="#contact" class="text-lg font-medium text-gray-300 hover:text-red-500 transition duration-300 px-3 py-2 rounded-md">Contact</a>
                </div>

                <div id="desktop-user-actions" class="user-actions hidden md:flex items-center space-x-2">
                    </div>

                <div class="md:hidden">
                    <button id="mobile-menu-button" class="text-gray-300 hover:text-red-500 focus:outline-none focus:ring-2 focus:ring-red-500 rounded-md p-2">
                        <svg id="menu-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
                        <svg id="close-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                </div>
            </nav>

            <div id="mobile-menu" class="md:hidden hidden bg-gray-800 py-4 shadow-lg">
                <div class="flex flex-col items-center space-y-4">
                    <a href="index.html" class="text-lg font-medium text-gray-300 hover:text-red-500 transition duration-300 w-full text-center py-2 rounded-md" onclick="closeMobileMenu()">Home</a>
                    <a href="#booking" class="text-lg font-medium text-gray-300 hover:text-red-500 transition duration-300 w-full text-center py-2 rounded-md" onclick="closeMobileMenu()">Book a Flight</a>
                    <a href="#contact" class="text-lg font-medium text-gray-300 hover:text-red-500 transition duration-300 w-full text-center py-2 rounded-md" onclick="closeMobileMenu()">Contact</a>
                    <div id="mobile-user-actions" class="user-actions w-full text-center py-2">
                        </div>
                </div>
            </div>
        </header>

        <main class="container container-sleek mx-auto py-section-sleek px-6 md:px-12">
            <section id="booking-form-section" class="card-background-sleek p-8 md:p-12 mb-content-sleek relative overflow-hidden">
                <h2 class="section-heading-sleek text-center mx-auto mb-10">Book Your Virtual Flight</h2>
                <p class="text-center text-lg mb-10 max-w-2xl mx-auto text-slate-400">
                    Plan your next virtual journey with Iberia VA. Select your departure, arrival, and flight details below.
                </p>

                <div id="loginRequiredMessage" class="hidden">
                    <p class="font-semibold">Please log in with Discord to book a flight.</p>
                    <div id="loginButtonContainer">
                        </div>
                </div>

                <div class="max-w-xl mx-auto form-container-sleek">
                  <form id="flightBookingForm" action="https://formcarry.com/s/B6IGRQkIQFb" method="POST" class="space-y-6">
    <input type="hidden" name="Discord Username" id="discordUsernameHidden">
    <div>
        <label for="origin" class="block text-slate-300 text-sm font-semibold mb-2">Departure Airport:</label>
        <select id="origin" name="Departure Airport" class="input-field-sleek w-full" required>
            <option value="">Select Departure Airport</option>
            </select>
    </div>

    <div>
        <label for="destination" class="block text-slate-300 text-sm font-semibold mb-2">Arrival Airport:</label>
        <select id="destination" name="Arrival Airport" class="input-field-sleek w-full" required>
            <option value="">Select Arrival Airport</option>
            </select>
    </div>

    <div>
        <label for="flight-date" class="block text-slate-300 text-sm font-semibold mb-2">Departure Date:</label>
        <input type="date" id="flight-date" name="Departure Date" class="input-field-sleek w-full" required>
    </div>

    <div>
        <label for="passengers" class="block text-slate-300 text-sm font-semibold mb-2">Number of Passengers:</label>
        <input type="number" id="passengers" name="Number of Passengers" min="1" value="1" class="input-field-sleek w-full" required>
    </div>

    <div>
        <label for="flight-class" class="block text-slate-300 text-sm font-semibold mb-2">Class:</label>
        <select id="flight-class" name="Flight Class" class="input-field-sleek w-full" required>
            <option value="Economy">Economy</option>
            <option value="Business">Business</option>
            <option value="First Class">First Class</option>
        </select>
    </div>

    <div class="flex justify-center pt-4">
        <button type="submit" class="btn-submit-sleek">
            Submit Booking
        </button>
    </div>
</form>
        <footer class="bg-gray-950 text-gray-400 py-8 border-t border-slate-800">
            <div class="container mx-auto px-6 text-center">
                <p class="mb-4">© <span id="current-year"></span> Iberia VA. All rights reserved.</p>
                <div class="flex justify-center space-x-6">
                    <a href="https://www.instagram.com/iberiava_pf/" class="hover:text-white transition duration-300">Instagram</a>
                    <a href="https://www.youtube.com/channel/UCahgitUZD7SNT2pVCie3ymQ" class="hover:text-white transition duration-300">Youtube</a>
                    <a href="https://discord.gg/vcfDHnpK22" class="hover:text-white transition duration-300">Discord</a>
                </div>
            </div>
        </footer>
    </div> <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Get the current year for the footer
            document.getElementById('current-year').textContent = new Date().getFullYear();

            // Mobile menu toggle logic
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const menuIcon = document.getElementById('menu-icon');
            const closeIcon = document.getElementById('close-icon');

            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
                menuIcon.classList.toggle('hidden');
                closeIcon.classList.toggle('hidden');
            });

            // Function to close mobile menu when a link is clicked
            function closeMobileMenu() {
                mobileMenu.classList.add('hidden');
                menuIcon.classList.remove('hidden');
                closeIcon.classList.add('hidden');
            }

            // Scroll to top button logic
            const scrollToTopBtn = document.getElementById('scrollToTopBtn');

            // When the user scrolls down 20px from the top of the document, show the button
            window.onscroll = function() { scrollFunction() };

            function scrollFunction() {
                if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                    scrollToTopBtn.style.display = "block";
                } else {
                    scrollToTopBtn.style.display = "none";
                }
            }

            // When the user clicks on the button, scroll to the top of the document
            scrollToTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

         // Loading Screen Logic
            const loadingScreen = document.getElementById('loading-screen');
            const mainContent = document.getElementById('main-content');
            const loadingVideo = loadingScreen.querySelector('video');

            // Hide main content initially
            mainContent.style.display = 'none'; // Ensure this is set to none initially

            // Always use a timeout, regardless of video
            // For testing, make it very short (e.g., 500ms or 1000ms)
            setTimeout(() => {
                // Check if elements exist before trying to modify their style
                if (loadingScreen && mainContent) {
                    loadingScreen.style.display = 'none';
                    mainContent.style.display = 'block';
                } else {
                    console.warn("Loading screen or main content element not found!");
                }
            }, 1000); // Try 1 second first. If this works, the video/onended was the issue.

            // Optional: You can keep the video.play() for visual effect
            if (loadingVideo) {
                loadingVideo.play().catch(e => console.error("Video play failed:", e));
            }

            // Flight data based on your provided routes
            const airports = [
                "Gran Canaria", "Punta Cana", "Larnaca", "London Gatwick",
                "London Southampton", "Kittila", "Cibao", "Arroyo Barril", "Menorca"
            ].sort(); // Sort alphabetically for better user experience

            const originSelect = document.getElementById('origin');
            const destinationSelect = document.getElementById('destination');
            const flightBookingForm = document.getElementById('flightBookingForm');
            const discordUsernameHidden = document.getElementById('discordUsernameHidden');

            const messageBoxOverlay = document.getElementById('messageBoxOverlay');
            const messageBoxTitle = document.getElementById('messageBoxTitle');
            const messageBoxText = document.getElementById('messageBoxText');
            const messageBoxCloseButton = document.getElementById('messageBoxCloseButton');
            const loginRequiredMessage = document.getElementById('loginRequiredMessage');
            const loginButtonContainer = document.getElementById('loginButtonContainer');


            // Function to show custom message box
            function showMessageBox(title, message) {
                messageBoxTitle.textContent = title;
                messageBoxText.textContent = message;
                messageBoxOverlay.classList.add('show');
            }

            // Function to hide custom message box
            function hideMessageBox() {
                messageBoxOverlay.classList.remove('show');
            }

            // Populate dropdowns with airport options
            function populateAirportSelects() {
                originSelect.innerHTML = '<option value="">Select Departure Airport</option>';
                destinationSelect.innerHTML = '<option value="">Select Arrival Airport</option>';
                airports.forEach(airport => {
                    const optionOrigin = document.createElement('option');
                    optionOrigin.value = airport;
                    optionOrigin.textContent = airport;
                    originSelect.appendChild(optionOrigin);

                    const optionDestination = document.createElement('option');
                    optionDestination.value = airport;
                    optionDestination.textContent = airport;
                    destinationSelect.appendChild(optionDestination);
                });
            }

            populateAirportSelects();

            // Function to enable/disable form fields
            function toggleFormFields(enable) {
                const formElements = flightBookingForm.querySelectorAll('input, select, button');
                formElements.forEach(element => {
                    element.disabled = !enable;
                    if (!enable) {
                        element.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        element.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                });
            }


            // Populate Discord username from localStorage
            const userFromLocalStorage = JSON.parse(localStorage.getItem("discordUser"));
            if (userFromLocalStorage && userFromLocalStorage.username) {
                const username = userFromLocalStorage.discriminator && userFromLocalStorage.discriminator !== '0'
                    ? `${userFromLocalStorage.username}#${userFromLocalStorage.discriminator}`
                    : userFromLocalStorage.username;
                discordUsernameHidden.value = username;
            } else {
                discordUsernameHidden.value = "Not Logged In (or error)";
            }


            // Handle form submission
            flightBookingForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // Prevent default form submission

                const origin = originSelect.value;
                const destination = destinationSelect.value;
                const flightDate = document.getElementById('flight-date').value;
                const passengers = document.getElementById('passengers').value;
                const flightClass = document.getElementById('flight-class').value; // Get the selected class

                // Basic validation
                if (origin === "" || destination === "" || flightDate === "" || passengers === "" || flightClass === "") {
                    showMessageBox("Validation Error", "Please fill in all flight details.");
                    return;
                }

                if (origin === destination) {
                    showMessageBox("Invalid Route", "Departure and Arrival airports cannot be the same. Please select different airports.");
                    return;
                }

                // Use FormData to easily get all form data
                const formData = new FormData(flightBookingForm);

                try {
                    const response = await fetch(flightBookingForm.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'Accept': 'application/json' // Important for Formcarry to return JSON
                        }
                    });

                    if (response.ok) {
                        showMessageBox("Booking Submitted!", "Your flight booking request has been successfully sent. We will get back to you shortly!");
                        flightBookingForm.reset(); // Clear form after successful submission
                        populateAirportSelects(); // Re-populate to reset dropdowns correctly
                        document.getElementById('passengers').value = "1"; // Reset passenger count
                        document.getElementById('flight-class').value = "Economy"; // Reset class
                    } else {
                        const data = await response.json();
                        if (data.errors) {
                            showMessageBox("Submission Failed", `There was an issue with your submission: ${data.errors.map(err => err.message).join(', ')}. Please try again.`);
                        } else {
                            showMessageBox("Submission Failed", "There was an error submitting your booking. Please try again later.");
                        }
                    }
                } catch (error) {
                    console.error('Error submitting form:', error);
                    showMessageBox("Submission Error", "An unexpected error occurred. Please check your internet connection and try again.");
                }
            });

            // Close message box when button is clicked
            messageBoxCloseButton.addEventListener('click', hideMessageBox);
            // Close message box if clicking outside the content
            messageBoxOverlay.addEventListener('click', (event) => {
                if (event.target === messageBoxOverlay) {
                    hideMessageBox();
                }
            });

            // Discord Login Integration
            const CLIENT_ID = "1396149795470446692";
            const REDIRECT_URI = "https://pfiberiava.github.io/flyibe/flightbooking.html";

            const AUTH_URL = `https://discord.com/oauth2/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=identify`;

            const userActionsDivs = document.querySelectorAll(".user-actions");

            function showUser(user) {
                const avatarUrl = user.avatar ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png` : 'https://discord.com/assets/f135b1fcd3d2c4935480d19e910540d5.png';
                userActionsDivs.forEach(div => {
                    div.innerHTML = `
                        <div class="user-info">
                            <img src="${avatarUrl}" alt="User Avatar">
                            <span>${user.username}</span>
                            <button class="logout-button">Logout</button>
                        </div>
                    `;
                    const logoutButton = div.querySelector(".logout-button");
                    if (logoutButton) {
                        logoutButton.onclick = () => {
                            localStorage.removeItem("discordUser");
                            window.location.href = REDIRECT_URI;
                        };
                    }
                });
                if (loginRequiredMessage) loginRequiredMessage.classList.add('hidden');
                if (flightBookingForm) flightBookingForm.classList.remove('hidden');
                toggleFormFields(true);
            }

            function showLoginButton() {
                userActionsDivs.forEach(div => {
                    div.innerHTML = `
                       <a href="${AUTH_URL}" class="Btn">
                            <span class="svgContainer">
                                <svg viewBox="0 0 640 512" fill="white" height="1.4em" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M524.5 69.8a1.5 1.5 0 0 0 -.8-.7A485.1 485.1 0 0 0 404.1 32a1.8 1.8 0 0 0 -1.9 .9 337.5 337.5 0 0 0 -14.9 30.6 447.8 447.8 0 0 0 -134.4 0 309.5 309.5 0 0 0 -15.1-30.6 1.9 1.9 0 0 0 -1.9-.9A483.7 483.7 0 0 0 116.1 69.1a1.7 1.7 0 0 0 -.8 .7C39.1 183.7 18.2 294.7 28.4 404.4a2 2 0 0 0 .8 1.4A487.7 487.7 0 0 0 176 479.9a1.9 1.9 0 0 0 2.1-.7A348.2 348.2 0 0 0 208.1 430.4a1.9 1.9 0 0 0 -1-2.6 321.2 321.2 0 0 1 -45.9-21.9 1.9 1.9 0 0 1 -.2-3.1c3.1-2.3 6.2-4.7 9.1-7.1a1.8 1.8 0 0 1 1.9-.3c96.2 43.9 200.4 43.9 295.5 0a1.8 1.8 0 0 1 1.9 .2c2.9 2.4 6 4.9 9.1 7.2a1.9 1.9 0 0 1 -.2 3.1 301.4 301.4 0 0 1 -45.9 21.8 1.9 1.9 0 0 0 -1 2.6 391.1 391.1 0 0 0 30 48.8 1.9 1.9 0 0 0 2.1 .7A486 486 0 0 0 610.7 405.7a1.9 1.9 0 0 0 .8-1.4C623.7 277.6 590.9 167.5 524.5 69.8zM222.5 337.6c-29 0-52.8-26.6-52.8-59.2S193.1 219.1 222.5 219.1c29.7 0 53.3 26.8 52.8 59.2C275.3 311 251.9 337.6 222.5 337.6zm195.4 0c-29 0-52.8-26.6-52.8-59.2S388.4 219.1 417.9 219.1c29.7 0 53.3 26.8 52.8 59.2C470.7 311 447.5 337.6 417.9 337.6z"></path>
                                </svg>
                            </span>
                            <span class="BG"></span>
                        </a>
                    `;
                });
                if (loginRequiredMessage) {
                    loginRequiredMessage.classList.remove('hidden');
                    const loginBtnHtml = `
                       <a href="${AUTH_URL}" class="Btn">
                            <span class="svgContainer">
                                <svg viewBox="0 0 640 512" fill="white" height="1.4em" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M524.5 69.8a1.5 1.5 0 0 0 -.8-.7A485.1 485.1 0 0 0 404.1 32a1.8 1.8 0 0 0 -1.9 .9 337.5 337.5 0 0 0 -14.9 30.6 447.8 447.8 0 0 0 -134.4 0 309.5 309.5 0 0 0 -15.1-30.6 1.9 1.9 0 0 0 -1.9-.9A483.7 483.7 0 0 0 116.1 69.1a1.7 1.7 0 0 0 -.8 .7C39.1 183.7 18.2 294.7 28.4 404.4a2 2 0 0 0 .8 1.4A487.7 487.7 0 0 0 176 479.9a1.9 1.9 0 0 0 2.1-.7A348.2 348.2 0 0 0 208.1 430.4a1.9 1.9 0 0 0 -1-2.6 321.2 321.2 0 0 1 -45.9-21.9 1.9 1.9 0 0 1 -.2-3.1c3.1-2.3 6.2-4.7 9.1-7.1a1.8 1.8 0 0 1 1.9-.3c96.2 43.9 200.4 43.9 295.5 0a1.8 1.8 0 0 1 1.9 .2c2.9 2.4 6 4.9 9.1 7.2a1.9 1.9 0 0 1 -.2 3.1 301.4 301.4 0 0 1 -45.9 21.8 1.9 1.9 0 0 0 -1 2.6 391.1 391.1 0 0 0 30 48.8 1.9 1.9 0 0 0 2.1 .7A486 486 0 0 0 610.7 405.7a1.9 1.9 0 0 0 .8-1.4C623.7 277.6 590.9 167.5 524.5 69.8zM222.5 337.6c-29 0-52.8-26.6-52.8-59.2S193.1 219.1 222.5 219.1c29.7 0 53.3 26.8 52.8 59.2C275.3 311 251.9 337.6 222.5 337.6zm195.4 0c-29 0-52.8-26.6-52.8-59.2S388.4 219.1 417.9 219.1c29.7 0 53.3 26.8 52.8 59.2C470.7 311 447.5 337.6 417.9 337.6z"></path>
                                </svg>
                            </span>
                            <span class="BG"></span>
                        </a>
                    `;
                    if (loginButtonContainer) loginButtonContainer.innerHTML = loginBtnHtml;
                }
                if (flightBookingForm) flightBookingForm.classList.add('hidden');
                toggleFormFields(false);
            }

            // --- Main login state management logic ---
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const token = params.get("access_token");

            const savedUser = JSON.parse(localStorage.getItem("discordUser"));

            if (token) {
                window.history.replaceState({}, document.title, REDIRECT_URI);

                fetch("https://discord.com/api/users/@me", {
                    headers: {
                        Authorization: `Bearer ${token}`
                    }
                })
                .then(res => {
                    if (!res.ok) {
                        console.error("Discord API error:", res.status, res.statusText);
                        localStorage.removeItem("discordUser"); // Clear invalid user data
                        showLoginButton();
                        throw new Error("Failed to fetch Discord user data.");
                    }
                    return res.json();
                })
                .then(user => {
                    localStorage.setItem("discordUser", JSON.stringify(user));
                    discordUsernameHidden.value = user.discriminator && user.discriminator !== '0'
                                                ? `${user.username}#${user.discriminator}`
                                                : user.username;
                    showUser(user);
                })
                .catch(error => {
                    console.error("Error during Discord authentication:", error);
                    showLoginButton();
                });
            } else if (savedUser) {
                // If no token in URL but user data in localStorage, display user info
                discordUsernameHidden.value = savedUser.discriminator && savedUser.discriminator !== '0'
                                            ? `${savedUser.username}#${savedUser.discriminator}`
                                            : savedUser.username;
                showUser(savedUser);
            } else {
                // No token, no saved user - show login button
                showLoginButton();
            }
        });
    </script>
</body>
</html>
